name: Update Homebrew SHA256

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v2.0.2)'
        required: true
        type: string

jobs:
  update-homebrew-sha:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Determine tag
        id: get_tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "TAG=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Download release and calculate SHA256
        id: calculate_sha
        run: |
          TAG="${{ steps.get_tag.outputs.TAG }}"
          URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz"
          
          echo "Downloading release from: $URL"
          curl -sL "$URL" -o release.tar.gz
          
          SHA256=$(shasum -a 256 release.tar.gz | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT
          echo "Calculated SHA256: $SHA256"
      
      - name: Checkout homebrew-tap branch
        run: |
          git checkout homebrew-tap
      
      - name: Update Formula
        run: |
          TAG="${{ steps.get_tag.outputs.TAG }}"
          SHA256="${{ steps.calculate_sha.outputs.SHA256 }}"
          VERSION="${TAG#v}"
          
          # Update SHA256 in formula
          sed -i "s/sha256 \"[^\"]*\"/sha256 \"$SHA256\"/" Formula/dotfiles-plus.rb
          
          # Ensure version and URL are correct
          sed -i "s/version \"[^\"]*\"/version \"$VERSION\"/" Formula/dotfiles-plus.rb
          sed -i "s|/v[0-9]\+\.[0-9]\+\.[0-9]\+\.tar\.gz|/${TAG}.tar.gz|" Formula/dotfiles-plus.rb
          
          echo "Updated Formula/dotfiles-plus.rb with SHA256: $SHA256"
      
      - name: Commit and push changes
        run: |
          TAG="${{ steps.get_tag.outputs.TAG }}"
          git add Formula/dotfiles-plus.rb
          git commit -m "chore: update formula SHA256 for ${TAG}"
          git push origin homebrew-tap
      
      - name: Create summary
        run: |
          TAG="${{ steps.get_tag.outputs.TAG }}"
          SHA256="${{ steps.calculate_sha.outputs.SHA256 }}"
          
          echo "## âœ… Homebrew Formula Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA256**: \`${SHA256}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: homebrew-tap" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Test Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "brew untap anivar/dotfiles-plus" >> $GITHUB_STEP_SUMMARY
          echo "brew tap anivar/dotfiles-plus https://github.com/${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "brew install dotfiles-plus" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY